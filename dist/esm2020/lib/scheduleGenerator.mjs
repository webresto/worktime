import { TimeZoneIdentifier } from "./tz";
export class ScheduleGenerator {
    /**
     * Constructor for the ScheduleGenerator class.
     * Parses the given worktime array into days and breaks.
     * @param worktime An array of WorkTime objects representing the work schedule.
     */
    constructor(worktime) {
        const { days, breaks } = this.parseSchedule(worktime);
        this.days = days;
        this.breaks = breaks;
    }
    timeToSeconds(time) {
        const [hours, minutes] = time.split(':').map(Number);
        return hours * 3600 + minutes * 60;
    }
    parseSchedule(worktime) {
        const days = new Map();
        const breaks = new Map();
        for (const rule of worktime) {
            const { dayOfWeek, start, stop, break: breakTime } = rule;
            const startSeconds = this.timeToSeconds(start);
            const stopSeconds = this.timeToSeconds(stop);
            const breakSeconds = breakTime !== "00:00-00:00" ? this.parseBreakTime(breakTime) : null;
            for (const day of dayOfWeek) {
                days.set(day.toLowerCase(), { start: startSeconds, stop: stopSeconds });
                if (breakSeconds)
                    breaks.set(day.toLowerCase(), breakSeconds);
            }
        }
        return { days, breaks };
    }
    parseBreakTime(breakTime) {
        const [start, stop] = breakTime.split('-').map(time => this.timeToSeconds(time));
        return { start, stop };
    }
    getDatesInRange(startDate, endDate) {
        const dates = [];
        const currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            dates.push(new Date(currentDate));
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return dates;
    }
    filterWorkingDates(dates) {
        return dates.filter(date => {
            const dayOfWeek = date.toLocaleString('en', { weekday: 'long' }).toLowerCase();
            return this.days.has(dayOfWeek);
        });
    }
    createTimeIntervals(dates) {
        const intervals = [];
        for (const date of dates) {
            const dayOfWeek = date.toLocaleString('en', { weekday: 'long' }).toLowerCase();
            const workingDay = this.days.get(dayOfWeek);
            if (workingDay && workingDay.start !== null && workingDay.stop !== null) {
                const { start, stop } = workingDay;
                const intervalStart = new Date(date);
                intervalStart.setHours(0, 0, start);
                const intervalStop = new Date(date);
                intervalStop.setHours(0, 0, stop);
                const breakTime = this.breaks.get(dayOfWeek);
                if (breakTime && breakTime.start < breakTime.stop) {
                    const breakStart = new Date(date);
                    breakStart.setHours(0, 0, breakTime.start);
                    const breakStop = new Date(date);
                    breakStop.setHours(0, 0, breakTime.stop);
                    intervals.push({ start: Math.round(intervalStart.getTime() / 1000), stop: Math.round(breakStart.getTime() / 1000) });
                    intervals.push({ start: Math.round(breakStop.getTime() / 1000), stop: Math.round(intervalStop.getTime() / 1000) });
                }
                else {
                    intervals.push({ start: Math.round(intervalStart.getTime() / 1000), stop: Math.round(intervalStop.getTime() / 1000) });
                }
            }
        }
        return intervals;
    }
    adjustTimezone(intervals, timeZoneOffset) {
        return intervals.map(interval => ({
            start: interval.start + timeZoneOffset,
            stop: interval.stop + timeZoneOffset
        }));
    }
    generateTimeIntervals(startDate, endDate, timeZone, compact) {
        const datesInRange = this.getDatesInRange(startDate, endDate);
        const workingDates = this.filterWorkingDates(datesInRange);
        const timeIntervals = this.createTimeIntervals(workingDates);
        if (!timeZone) {
            timeZone = "Etc/GMT+0";
        }
        const timeZoneOffsetSeconds = TimeZoneIdentifier.getTimeZoneOffsetInSeconds(timeZone);
        if (compact) {
            return this.compact(this.adjustTimezone(timeIntervals, timeZoneOffsetSeconds));
        }
        else {
            return this.adjustTimezone(timeIntervals, timeZoneOffsetSeconds);
        }
    }
    compact(timeIntervals) {
        return timeIntervals.map(interval => [interval.start, interval.stop]);
    }
}
export class ScheduleValidator {
    /**
     * Constructor for ScheduleValidator class.
     * @param schedule The schedule to be validated.
     */
    constructor(schedule) {
        this.schedule = schedule;
    }
    /**
     * Checks if a given date falls within any of the intervals in the schedule.
     * @param date The date to check.
     * @returns A boolean indicating whether the date falls within the schedule.
     */
    doesTimeFallWithin(date) {
        if (!this.schedule)
            return false;
        const time = Math.round(date.getTime() / 1000); // Convert date to Unix timestamp
        for (const interval of this.schedule) {
            const [start, stop] = interval;
            if (start <= time && time <= stop) {
                return true;
            }
        }
        return false;
    }
    /**
     * Checks if a given duration starting from a specific date falls within any of the intervals in the schedule.
     * @param startDateTime The start date and time.
     * @param durationInSeconds The duration in seconds.
     * @returns A boolean indicating whether the duration falls within the schedule.
     */
    doesDurationFallWithin(startDateTime, durationInSeconds) {
        if (!this.schedule)
            return false;
        const startTime = Math.round(startDateTime.getTime() / 1000);
        const endTime = startTime + durationInSeconds;
        for (const interval of this.schedule) {
            const [start, stop] = interval;
            if (start <= startTime && stop >= endTime) {
                return true;
            }
        }
        return false;
    }
    /**
     * Finds the earliest or latest day limit in the schedule intervals.
     * @param mode Determines whether to find the earliest or latest day limit.
     * @returns The earliest or latest day limit within the schedule, or undefined if no such date exists.
     */
    findDayLimit(mode, timezone) {
        if (!this.schedule || this.schedule.length === 0)
            return undefined;
        let _day = this.schedule[0][0];
        for (const interval of this.schedule) {
            const [_start, _] = interval;
            if (mode = "earliest") {
                if (_start < _day) {
                    _day = _start;
                }
            }
            else /** latest */ {
                if (_start > _day) {
                    _day = _start;
                }
            }
        }
        return new Date(_day * 1000).toLocaleDateString(undefined, {
            timeZone: timezone,
        });
    }
    /**
     * Finds the latest end date for a given duration that fits within the schedule intervals.
     * @param durationInSeconds The duration in seconds.
     * @returns The latest end date that fits within the schedule, or undefined if no such date exists.
     */
    findLatestEndDate() {
        return undefined;
    }
}
// function convertTimestampsToReadableDate(array: { start: number, stop: number }[]) {
//     return array.map(item => {
//         const startDate = new Date(item.start * 1000);
//         const stopDate = new Date(item.stop * 1000);
//         const startDateStr = startDate.toLocaleString('en-US', { timeZone: 'UTC' });
//         const stopDateStr = stopDate.toLocaleString('en-US', { timeZone: 'UTC' });
//         return { start: startDateStr, stop: stopDateStr };
//     });
// }
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGVHZW5lcmF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL3NjaGVkdWxlR2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxrQkFBa0IsRUFBa0IsTUFBTSxNQUFNLENBQUM7QUFHMUQsTUFBTSxPQUFPLGlCQUFpQjtJQUsxQjs7OztPQUlHO0lBQ0gsWUFBWSxRQUFvQjtRQUM1QixNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdEQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDekIsQ0FBQztJQUVPLGFBQWEsQ0FBQyxJQUFZO1FBQzlCLE1BQU0sQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDckQsT0FBTyxLQUFLLEdBQUcsSUFBSSxHQUFHLE9BQU8sR0FBRyxFQUFFLENBQUM7SUFDdkMsQ0FBQztJQUVPLGFBQWEsQ0FBQyxRQUFhO1FBQy9CLE1BQU0sSUFBSSxHQUFHLElBQUksR0FBRyxFQUEyQyxDQUFDO1FBQ2hFLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxFQUEyQyxDQUFDO1FBRWxFLEtBQUssTUFBTSxJQUFJLElBQUksUUFBUSxFQUFFO1lBQ3pCLE1BQU0sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLEdBQUcsSUFBSSxDQUFDO1lBQzFELE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDL0MsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMs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cnQgeyBUaW1lWm9uZUlkZW50aWZpZXIsIFRpbWVab25lU3RyaW5nIH0gZnJvbSBcIi4vdHpcIjtcbmltcG9ydCB7IFdvcmtUaW1lIH0gZnJvbSBcIi4vd29ya3RpbWUudmFsaWRhdG9yXCI7XG5leHBvcnQgdHlwZSBTY2hlZHVsZSA9ICBbbnVtYmVyLCBudW1iZXJdW11cbmV4cG9ydCBjbGFzcyBTY2hlZHVsZUdlbmVyYXRvciB7XG4gICAgcHJpdmF0ZSBkYXlzOiBNYXA8c3RyaW5nLCB7IHN0YXJ0OiBudW1iZXIsIHN0b3A6IG51bWJlciB9PjtcbiAgICBwcml2YXRlIGJyZWFrczogTWFwPHN0cmluZywgeyBzdGFydDogbnVtYmVyLCBzdG9wOiBudW1iZXIgfT47XG5cblxuICAgIC8qKlxuICAgICAqIENvbnN0cnVjdG9yIGZvciB0aGUgU2NoZWR1bGVHZW5lcmF0b3IgY2xhc3MuXG4gICAgICogUGFyc2VzIHRoZSBnaXZlbiB3b3JrdGltZSBhcnJheSBpbnRvIGRheXMgYW5kIGJyZWFrcy5cbiAgICAgKiBAcGFyYW0gd29ya3RpbWUgQW4gYXJyYXkgb2YgV29ya1RpbWUgb2JqZWN0cyByZXByZXNlbnRpbmcgdGhlIHdvcmsgc2NoZWR1bGUuXG4gICAgICovXG4gICAgY29uc3RydWN0b3Iod29ya3RpbWU6IFdvcmtUaW1lW10pIHtcbiAgICAgICAgY29uc3QgeyBkYXlzLCBicmVha3MgfSA9IHRoaXMucGFyc2VTY2hlZHVsZSh3b3JrdGltZSk7XG4gICAgICAgIHRoaXMuZGF5cyA9IGRheXM7XG4gICAgICAgIHRoaXMuYnJlYWtzID0gYnJlYWtzO1xuICAgIH1cblxuICAgIHByaXZhdGUgdGltZVRvU2Vjb25kcyh0aW1lOiBzdHJpbmcpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBbaG91cnMsIG1pbnV0ZXNdID0gdGltZS5zcGxpdCgnOicpLm1hcChOdW1iZXIpO1xuICAgICAgICByZXR1cm4gaG91cnMgKiAzNjAwICsgbWludXRlcyAqIDYwO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGFyc2VTY2hlZHVsZSh3b3JrdGltZTogYW55KTogeyBkYXlzOiBNYXA8c3RyaW5nLCB7IHN0YXJ0OiBudW1iZXIsIHN0b3A6IG51bWJlciB9PiwgYnJlYWtzOiBNYXA8c3RyaW5nLCB7IHN0YXJ0OiBudW1iZXIsIHN0b3A6IG51bWJlciB9PiB9IHtcbiAgICAgICAgY29uc3QgZGF5cyA9IG5ldyBNYXA8c3RyaW5nLCB7IHN0YXJ0OiBudW1iZXIsIHN0b3A6IG51bWJlciB9PigpO1xuICAgICAgICBjb25zdCBicmVha3MgPSBuZXcgTWFwPHN0cmluZywgeyBzdGFydDogbnVtYmVyLCBzdG9wOiBudW1iZXIgfT4oKTtcblxuICAgICAgICBmb3IgKGNvbnN0IHJ1bGUgb2Ygd29ya3RpbWUpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgZGF5T2ZXZWVrLCBzdGFydCwgc3RvcCwgYnJlYWs6IGJyZWFrVGltZSB9ID0gcnVsZTtcbiAgICAgICAgICAgIGNvbnN0IHN0YXJ0U2Vjb25kcyA9IHRoaXMudGltZVRvU2Vjb25kcyhzdGFydCk7XG4gICAgICAgICAgICBjb25zdCBzdG9wU2Vjb25kcyA9IHRoaXMudGltZVRvU2Vjb25kcyhzdG9wKTtcbiAgICAgICAgICAgIGNvbnN0IGJyZWFrU2Vjb25kcyA9IGJyZWFrVGltZSAhPT0gXCIwMDowMC0wMDowMFwiID8gdGhpcy5wYXJzZUJyZWFrVGltZShicmVha1RpbWUpIDogbnVsbDtcblxuICAgICAgICAgICAgZm9yIChjb25zdCBkYXkgb2YgZGF5T2ZXZWVrKSB7XG4gICAgICAgICAgICAgICAgZGF5cy5zZXQoZGF5LnRvTG93ZXJDYXNlKCksIHsgc3RhcnQ6IHN0YXJ0U2Vjb25kcywgc3RvcDogc3RvcFNlY29uZHMgfSk7XG4gICAgICAgICAgICAgICAgaWYgKGJyZWFrU2Vjb25kcykgYnJlYWtzLnNldChkYXkudG9Mb3dlckNhc2UoKSwgYnJlYWtTZWNvbmRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7IGRheXMsIGJyZWFrcyB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgcGFyc2VCcmVha1RpbWUoYnJlYWtUaW1lOiBzdHJpbmcpOiB7IHN0YXJ0OiBudW1iZXIsIHN0b3A6IG51bWJlciB9IHtcbiAgICAgICAgY29uc3QgW3N0YXJ0LCBzdG9wXSA9IGJyZWFrVGltZS5zcGxpdCgnLScpLm1hcCh0aW1lID0+IHRoaXMudGltZVRvU2Vjb25kcyh0aW1lKSk7XG4gICAgICAgIHJldHVybiB7IHN0YXJ0LCBzdG9wIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXREYXRlc0luUmFuZ2Uoc3RhcnREYXRlOiBEYXRlLCBlbmREYXRlOiBEYXRlKTogRGF0ZVtdIHtcbiAgICAgICAgY29uc3QgZGF0ZXMgPSBbXTtcbiAgICAgICAgY29uc3QgY3VycmVudERhdGUgPSBuZXcgRGF0ZShzdGFydERhdGUpO1xuXG4gICAgICAgIHdoaWxlIChjdXJyZW50RGF0ZSA8PSBlbmREYXRlKSB7XG4gICAgICAgICAgICBkYXRlcy5wdXNoKG5ldyBEYXRlKGN1cnJlbnREYXRlKSk7XG4gICAgICAgICAgICBjdXJyZW50RGF0ZS5zZXREYXRlKGN1cnJlbnREYXRlLmdldERhdGUoKSArIDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGRhdGVzO1xuICAgIH1cblxuICAgIHByaXZhdGUgZmlsdGVyV29ya2luZ0RhdGVzKGRhdGVzOiBEYXRlW10pOiBEYXRlW10ge1xuICAgICAgICByZXR1cm4gZGF0ZXMuZmlsdGVyKGRhdGUgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGF5T2ZXZWVrID0gZGF0ZS50b0xvY2FsZVN0cmluZygnZW4nLCB7IHdlZWtkYXk6ICdsb25nJyB9KS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF5cy5oYXMoZGF5T2ZXZWVrKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVUaW1lSW50ZXJ2YWxzKGRhdGVzOiBEYXRlW10pOiB7IHN0YXJ0OiBudW1iZXIsIHN0b3A6IG51bWJlciB9W10ge1xuICAgICAgICBjb25zdCBpbnRlcnZhbHMgPSBbXTtcblxuICAgICAgICBmb3IgKGNvbnN0IGRhdGUgb2YgZGF0ZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IGRheU9mV2VlayA9IGRhdGUudG9Mb2NhbGVTdHJpbmcoJ2VuJywgeyB3ZWVrZGF5OiAnbG9uZycgfSkudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIGNvbnN0IHdvcmtpbmdEYXkgPSB0aGlzLmRheXMuZ2V0KGRheU9mV2Vlayk7XG5cbiAgICAgICAgICAgIGlmICh3b3JraW5nRGF5ICYmIHdvcmtpbmdEYXkuc3RhcnQgIT09IG51bGwgJiYgd29ya2luZ0RheS5zdG9wICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgeyBzdGFydCwgc3RvcCB9ID0gd29ya2luZ0RheTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGludGVydmFsU3RhcnQgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICAgICAgICAgICAgICBpbnRlcnZhbFN0YXJ0LnNldEhvdXJzKDAsIDAsIHN0YXJ0KTtcbiAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnZhbFN0b3AgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICAgICAgICAgICAgICBpbnRlcnZhbFN0b3Auc2V0SG91cnMoMCwgMCwgc3RvcCk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBicmVha1RpbWUgPSB0aGlzLmJyZWFrcy5nZXQoZGF5T2ZXZWVrKTtcbiAgICAgICAgICAgICAgICBpZiAoYnJlYWtUaW1lICYmIGJyZWFrVGltZS5zdGFydCA8IGJyZWFrVGltZS5zdG9wKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJyZWFrU3RhcnQgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWtTdGFydC5zZXRIb3VycygwLCAwLCBicmVha1RpbWUuc3RhcnQpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBicmVha1N0b3AgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWtTdG9wLnNldEhvdXJzKDAsIDAsIGJyZWFrVGltZS5zdG9wKTtcblxuICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbHMucHVzaCh7IHN0YXJ0OiBNYXRoLnJvdW5kKGludGVydmFsU3RhcnQuZ2V0VGltZSgpIC8gMTAwMCksIHN0b3A6IE1hdGgucm91bmQoYnJlYWtTdGFydC5nZXRUaW1lKCkgLyAxMDAwKSB9KTtcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWxzLnB1c2goeyBzdGFydDogTWF0aC5yb3VuZChicmVha1N0b3AuZ2V0VGltZSgpIC8gMTAwMCksIHN0b3A6IE1hdGgucm91bmQoaW50ZXJ2YWxTdG9wLmdldFRpbWUoKSAvIDEwMDApIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGludGVydmFscy5wdXNoKHsgc3RhcnQ6IE1hdGgucm91bmQoaW50ZXJ2YWxTdGFydC5nZXRUaW1lKCkgLyAxMDAwKSwgc3RvcDogTWF0aC5yb3VuZChpbnRlcnZhbFN0b3AuZ2V0VGltZSgpIC8gMTAwMCkgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGludGVydmFscztcbiAgICB9XG5cbiAgICBwcml2YXRlIGFkanVzdFRpbWV6b25lKGludGVydmFsczogeyBzdGFydDogbnVtYmVyLCBzdG9wOiBudW1iZXIgfVtdLCB0aW1lWm9uZU9mZnNldDogbnVtYmVyKTogeyBzdGFydDogbnVtYmVyLCBzdG9wOiBudW1iZXIgfVtdIHtcbiAgICAgICAgcmV0dXJuIGludGVydmFscy5tYXAoaW50ZXJ2YWwgPT4gKHtcbiAgICAgICAgICAgIHN0YXJ0OiBpbnRlcnZhbC5zdGFydCArIHRpbWVab25lT2Zmc2V0LFxuICAgICAgICAgICAgc3RvcDogaW50ZXJ2YWwuc3RvcCArIHRpbWVab25lT2Zmc2V0XG4gICAgICAgIH0pKTtcbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqIEdlbmVyYXRlcyB0aW1lIGludGVydmFscyBiZXR3ZWVuIHRoZSBwcm92aWRlZCBzdGFydCBhbmQgZW5kIGRhdGVzLlxuICAgICAqIEBwYXJhbSBzdGFydERhdGUgVGhlIHN0YXJ0IGRhdGUgb2YgdGhlIGludGVydmFsLlxuICAgICAqIEBwYXJhbSBlbmREYXRlIFRoZSBlbmQgZGF0ZSBvZiB0aGUgaW50ZXJ2YWwuXG4gICAgICogQHBhcmFtIHRpbWVab25lIE9wdGlvbmFsOiBUaGUgdGltZSB6b25lIHRvIGNvbnNpZGVyIGZvciB0aGUgZGF0ZXMuIElmIG5vdCBwcm92aWRlZCwgYXNzdW1lcyBcIkV0Yy9HTVQrMFwiLiBJdCBpcyBub3QgbmVjZXNzYXJ5IGJlY2F1c2UgbmV3IERhdGUoKSBmb3Igc3RhcnREYXRlIGFuZCBlbmREYXRlIHdpbGwgYWxyZWFkeSBiZSBvZmZzZXRcbiAgICAgKiBAcGFyYW0gY29tcGFjdCBPcHRpb25hbDogV2hldGhlciB0byBvdXRwdXQgdGltZSBpbnRlcnZhbHMgaW4gYSBjb21wYWN0IGFycmF5IGZvcm1hdCBvciBhbiBhcnJheSBvZiBvYmplY3RzLlxuICAgICAqIEByZXR1cm5zIEFuIGFycmF5IG9mIHRpbWUgaW50ZXJ2YWxzIGJldHdlZW4gdGhlIHN0YXJ0IGFuZCBlbmQgZGF0ZXMuXG4gICAgICovXG4gICAgcHVibGljIGdlbmVyYXRlVGltZUludGVydmFscyhzdGFydERhdGU6IERhdGUsIGVuZERhdGU6IERhdGUsIHRpbWVab25lPzogVGltZVpvbmVTdHJpbmcsIGNvbXBhY3Q/OiB0cnVlKTogW251bWJlciwgbnVtYmVyXVtdO1xuICAgIHB1YmxpYyBnZW5lcmF0ZVRpbWVJbnRlcnZhbHMoc3RhcnREYXRlOiBEYXRlLCBlbmREYXRlOiBEYXRlLCB0aW1lWm9uZT86IFRpbWVab25lU3RyaW5nLCBjb21wYWN0PzogZmFsc2UpOiB7IHN0YXJ0OiBudW1iZXIsIHN0b3A6IG51bWJlciB9W107XG4gICAgcHVibGljIGdlbmVyYXRlVGltZUludGVydmFscyhzdGFydERhdGU6IERhdGUsIGVuZERhdGU6IERhdGUsIHRpbWVab25lPzogVGltZVpvbmVTdHJpbmcsIGNvbXBhY3Q/OiB0cnVlIHwgZmFsc2UpOiB7IHN0YXJ0OiBudW1iZXIsIHN0b3A6IG51bWJlciB9W10gfCBbbnVtYmVyLCBudW1iZXJdW10ge1xuICAgICAgICBjb25zdCBkYXRlc0luUmFuZ2UgPSB0aGlzLmdldERhdGVzSW5SYW5nZShzdGFydERhdGUsIGVuZERhdGUpO1xuICAgICAgICBjb25zdCB3b3JraW5nRGF0ZXMgPSB0aGlzLmZpbHRlcldvcmtpbmdEYXRlcyhkYXRlc0luUmFuZ2UpO1xuICAgICAgICBjb25zdCB0aW1lSW50ZXJ2YWxzID0gdGhpcy5jcmVhdGVUaW1lSW50ZXJ2YWxzKHdvcmtpbmdEYXRlcyk7XG4gICAgICAgIFxuICAgICAgICBpZighdGltZVpvbmUpIHtcbiAgICAgICAgICAgIHRpbWVab25lID0gXCJFdGMvR01UKzBcIlxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb25zdCB0aW1lWm9uZU9mZnNldFNlY29uZHMgPSBUaW1lWm9uZUlkZW50aWZpZXIuZ2V0VGltZVpvbmVPZmZzZXRJblNlY29uZHModGltZVpvbmUpXG4gICAgICAgIGlmKGNvbXBhY3Qpe1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29tcGFjdCh0aGlzLmFkanVzdFRpbWV6b25lKHRpbWVJbnRlcnZhbHMsIHRpbWVab25lT2Zmc2V0U2Vjb25kcykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRqdXN0VGltZXpvbmUodGltZUludGVydmFscywgdGltZVpvbmVPZmZzZXRTZWNvbmRzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcblxuICAgIHByaXZhdGUgY29tcGFjdCh0aW1lSW50ZXJ2YWxzOiB7IHN0YXJ0OiBudW1iZXIsIHN0b3A6IG51bWJlciB9W10pOiBbbnVtYmVyLCBudW1iZXJdW10ge1xuICAgICAgICByZXR1cm4gdGltZUludGVydmFscy5tYXAoaW50ZXJ2YWwgPT4gW2ludGVydmFsLnN0YXJ0LCBpbnRlcnZhbC5zdG9wXSk7XG4gICAgfVxufVxuXG5cbmV4cG9ydCBjbGFzcyBTY2hlZHVsZVZhbGlkYXRvciB7XG4gICAgcmVhZG9ubHkgc2NoZWR1bGU6IFNjaGVkdWxlIHwgdW5kZWZpbmVkO1xuICAgIFxuICAgIC8qKlxuICAgICAqIENvbnN0cnVjdG9yIGZvciBTY2hlZHVsZVZhbGlkYXRvciBjbGFzcy5cbiAgICAgKiBAcGFyYW0gc2NoZWR1bGUgVGhlIHNjaGVkdWxlIHRvIGJlIHZhbGlkYXRlZC5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihzY2hlZHVsZTogU2NoZWR1bGUpIHtcbiAgICAgICAgdGhpcy5zY2hlZHVsZSA9IHNjaGVkdWxlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBpZiBhIGdpdmVuIGRhdGUgZmFsbHMgd2l0aGluIGFueSBvZiB0aGUgaW50ZXJ2YWxzIGluIHRoZSBzY2hlZHVsZS5cbiAgICAgKiBAcGFyYW0gZGF0ZSBUaGUgZGF0ZSB0byBjaGVjay5cbiAgICAgKiBAcmV0dXJucyBBIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSBkYXRlIGZhbGxzIHdpdGhpbiB0aGUgc2NoZWR1bGUuXG4gICAgICovXG4gICAgZG9lc1RpbWVGYWxsV2l0aGluKGRhdGU6IERhdGUpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKCF0aGlzLnNjaGVkdWxlKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgY29uc3QgdGltZSA9IE1hdGgucm91bmQoZGF0ZS5nZXRUaW1lKCkgLyAxMDAwKTsgLy8gQ29udmVydCBkYXRlIHRvIFVuaXggdGltZXN0YW1wXG5cbiAgICAgICAgZm9yIChjb25zdCBpbnRlcnZhbCBvZiB0aGlzLnNjaGVkdWxlKSB7XG4gICAgICAgICAgICBjb25zdCBbc3RhcnQsIHN0b3BdID0gaW50ZXJ2YWw7XG4gICAgICAgICAgICBpZiAoc3RhcnQgPD0gdGltZSAmJiB0aW1lIDw9IHN0b3ApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgaWYgYSBnaXZlbiBkdXJhdGlvbiBzdGFydGluZyBmcm9tIGEgc3BlY2lmaWMgZGF0ZSBmYWxscyB3aXRoaW4gYW55IG9mIHRoZSBpbnRlcnZhbHMgaW4gdGhlIHNjaGVkdWxlLlxuICAgICAqIEBwYXJhbSBzdGFydERhdGVUaW1lIFRoZSBzdGFydCBkYXRlIGFuZCB0aW1lLlxuICAgICAqIEBwYXJhbSBkdXJhdGlvbkluU2Vjb25kcyBUaGUgZHVyYXRpb24gaW4gc2Vjb25kcy5cbiAgICAgKiBAcmV0dXJucyBBIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSBkdXJhdGlvbiBmYWxscyB3aXRoaW4gdGhlIHNjaGVkdWxlLlxuICAgICAqL1xuICAgIGRvZXNEdXJhdGlvbkZhbGxXaXRoaW4oc3RhcnREYXRlVGltZTogRGF0ZSwgZHVyYXRpb25JblNlY29uZHM6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoIXRoaXMuc2NoZWR1bGUpIHJldHVybiBmYWxzZTtcblxuICAgICAgICBjb25zdCBzdGFydFRpbWUgPSBNYXRoLnJvdW5kKHN0YXJ0RGF0ZVRpbWUuZ2V0VGltZSgpIC8gMTAwMCk7XG4gICAgICAgIGNvbnN0IGVuZFRpbWUgPSBzdGFydFRpbWUgKyBkdXJhdGlvbkluU2Vjb25kcztcblxuICAgICAgICBmb3IgKGNvbnN0IGludGVydmFsIG9mIHRoaXMuc2NoZWR1bGUpIHtcbiAgICAgICAgICAgIGNvbnN0IFtzdGFydCwgc3RvcF0gPSBpbnRlcnZhbDtcbiAgICAgICAgICAgIGlmIChzdGFydCA8PSBzdGFydFRpbWUgJiYgc3RvcCA+PSBlbmRUaW1lKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmluZHMgdGhlIGVhcmxpZXN0IG9yIGxhdGVzdCBkYXkgbGltaXQgaW4gdGhlIHNjaGVkdWxlIGludGVydmFscy5cbiAgICAgKiBAcGFyYW0gbW9kZSBEZXRlcm1pbmVzIHdoZXRoZXIgdG8gZmluZCB0aGUgZWFybGllc3Qgb3IgbGF0ZXN0IGRheSBsaW1pdC5cbiAgICAgKiBAcmV0dXJucyBUaGUgZWFybGllc3Qgb3IgbGF0ZXN0IGRheSBsaW1pdCB3aXRoaW4gdGhlIHNjaGVkdWxlLCBvciB1bmRlZmluZWQgaWYgbm8gc3VjaCBkYXRlIGV4aXN0cy5cbiAgICAgKi9cbiAgICBmaW5kRGF5TGltaXQobW9kZTogXCJlYXJsaWVzdFwifFwibGF0ZXN0XCIsIHRpbWV6b25lOiBUaW1lWm9uZVN0cmluZyk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgXG4gICAgICAgIGlmICghdGhpcy5zY2hlZHVsZSB8fCB0aGlzLnNjaGVkdWxlLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHVuZGVmaW5lZDtcblxuICAgICAgICBsZXQgX2RheSA9IHRoaXMuc2NoZWR1bGVbMF1bMF07XG5cbiAgICAgICAgZm9yIChjb25zdCBpbnRlcnZhbCBvZiB0aGlzLnNjaGVkdWxlKSB7XG4gICAgICAgICAgICBjb25zdCBbX3N0YXJ0LCBfXSA9IGludGVydmFsO1xuICAgICAgICAgICAgaWYobW9kZSA9IFwiZWFybGllc3RcIikge1xuICAgICAgICAgICAgICAgIGlmIChfc3RhcnQgPCBfZGF5KSB7XG4gICAgICAgICAgICAgICAgICAgIF9kYXkgPSBfc3RhcnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIC8qKiBsYXRlc3QgKi8ge1xuICAgICAgICAgICAgICAgIGlmIChfc3RhcnQgPiBfZGF5KSB7XG4gICAgICAgICAgICAgICAgICAgIF9kYXkgPSBfc3RhcnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKF9kYXkgKiAxMDAwKS50b0xvY2FsZURhdGVTdHJpbmcodW5kZWZpbmVkLCB7XG4gICAgICAgICAgICB0aW1lWm9uZTogdGltZXpvbmUsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmRzIHRoZSBsYXRlc3QgZW5kIGRhdGUgZm9yIGEgZ2l2ZW4gZHVyYXRpb24gdGhhdCBmaXRzIHdpdGhpbiB0aGUgc2NoZWR1bGUgaW50ZXJ2YWxzLlxuICAgICAqIEBwYXJhbSBkdXJhdGlvbkluU2Vjb25kcyBUaGUgZHVyYXRpb24gaW4gc2Vjb25kcy5cbiAgICAgKiBAcmV0dXJucyBUaGUgbGF0ZXN0IGVuZCBkYXRlIHRoYXQgZml0cyB3aXRoaW4gdGhlIHNjaGVkdWxlLCBvciB1bmRlZmluZWQgaWYgbm8gc3VjaCBkYXRlIGV4aXN0cy5cbiAgICAgKi9cbiAgICBmaW5kTGF0ZXN0RW5kRGF0ZSgpOiBEYXRlIHwgdW5kZWZpbmVkIHtcblxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxufVxuXG4vLyBmdW5jdGlvbiBjb252ZXJ0VGltZXN0YW1wc1RvUmVhZGFibGVEYXRlKGFycmF5OiB7IHN0YXJ0OiBudW1iZXIsIHN0b3A6IG51bWJlciB9W10pIHtcbi8vICAgICByZXR1cm4gYXJyYXkubWFwKGl0ZW0gPT4ge1xuLy8gICAgICAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZShpdGVtLnN0YXJ0ICogMTAwMCk7XG4vLyAgICAgICAgIGNvbnN0IHN0b3BEYXRlID0gbmV3IERhdGUoaXRlbS5zdG9wICogMTAwMCk7XG5cbi8vICAgICAgICAgY29uc3Qgc3RhcnREYXRlU3RyID0gc3RhcnREYXRlLnRvTG9jYWxlU3RyaW5nKCdlbi1VUycsIHsgdGltZVpvbmU6ICdVVEMnIH0pO1xuLy8gICAgICAgICBjb25zdCBzdG9wRGF0ZVN0ciA9IHN0b3BEYXRlLnRvTG9jYWxlU3RyaW5nKCdlbi1VUycsIHsgdGltZVpvbmU6ICdVVEMnIH0pO1xuXG4vLyAgICAgICAgIHJldHVybiB7IHN0YXJ0OiBzdGFydERhdGVTdHIsIHN0b3A6IHN0b3BEYXRlU3RyIH07XG4vLyAgICAgfSk7XG4vLyB9XG4iXX0=